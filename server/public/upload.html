<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArbanTV â€“ Professional Upload</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; background: #f4f7f6; }
    .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { margin-top: 0; color: #333; }
    label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #666; }
    input { width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    .btn-group { display: flex; gap: 10px; }
    .btn { flex: 1; padding: 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #007bff; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .progress-wrap { height: 12px; background: #eee; border-radius: 6px; margin: 1.5rem 0; overflow: hidden; display: none; }
    .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.3s; }
    .status { padding: 1rem; border-radius: 4px; margin-top: 1rem; font-size: 0.9rem; border-left: 4px solid #007bff; background: #e7f3ff; }
    .status.error { border-color: #dc3545; background: #f8d7da; color: #721c24; }
    .status.success { border-color: #28a745; background: #d4edda; color: #155724; }
    video { width: 100%; margin-top: 1rem; border-radius: 4px; background: #000; }
  </style>
</head>
<body>

<div class="card">
  <h1>ArbanTV Upload</h1>
  
  <label>User ID</label>
  <input type="text" id="userId" value="user-1">

  <label>Video File</label>
  <input type="file" id="fileInput" accept="video/*">

  <div class="btn-group">
    <button id="btnStart" class="btn btn-primary" disabled>Start Upload</button>
    <button id="btnPause" class="btn btn-secondary" disabled>Pause</button>
  </div>

  <div class="progress-wrap" id="progressWrap">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div id="status" class="status">Ready to upload.</div>
  
  <div id="videoWrap" style="display:none;">
    <label>Preview</label>
    <video id="videoPlayer" controls></video>
  </div>
</div>

<script>
  const API_UPLOADS = '/api/uploads';
  let uploadId, file, chunkSize, totalChunks, uploadedCount = 0, paused = false;

  const dom = {
    file: document.getElementById('fileInput'),
    start: document.getElementById('btnStart'),
    pause: document.getElementById('btnPause'),
    status: document.getElementById('status'),
    progress: document.getElementById('progressBar'),
    wrap: document.getElementById('progressWrap'),
    player: document.getElementById('videoPlayer'),
    videoWrap: document.getElementById('videoWrap')
  };

  dom.file.onchange = () => {
    dom.start.disabled = !dom.file.files.length;
    dom.status.textContent = "File selected. Click Start.";
    dom.status.className = "status";
  };

  async function runUpload() {
    try {
      const userId = document.getElementById('userId').value;
      file = dom.file.files[0];
      uploadedCount = 0;
      paused = false;

      // 1. INIT SESSION
      dom.status.textContent = "Initializing session on server...";
      const initRes = await fetch(`${API_UPLOADS}/init`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileName: file.name, fileSize: file.size, userId })
      });

      if (!initRes.ok) throw new Error("Server failed to initialize session.");
      
      const session = await initRes.json();
      uploadId = session.sessionId;
      chunkSize = session.chunkSize;
      totalChunks = session.totalChunks;

      dom.wrap.style.display = 'block';
      dom.pause.disabled = false;

      // 2. CHUNK UPLOAD LOOP
      for (let i = 0; i < totalChunks; i++) {
        while (paused) {
          dom.status.textContent = "Upload paused...";
          await new Promise(r => setTimeout(r, 500));
        }

        const start = i * chunkSize;
        const blob = file.slice(start, start + chunkSize);
        const fd = new FormData();
        fd.append('chunk', blob);
        fd.append('chunkIndex', i);
        fd.append('userId', userId);

        dom.status.textContent = `Uploading chunk ${i + 1} of ${totalChunks}...`;

        const chunkRes = await fetch(`${API_UPLOADS}/${uploadId}/chunk`, { 
          method: 'POST', 
          body: fd 
        });

        if (!chunkRes.ok) {
          const errData = await chunkRes.json();
          throw new Error(`Chunk ${i} failed: ${errData.error || 'Unknown error'}`);
        }
        
        uploadedCount++;
        const pct = Math.round((uploadedCount / totalChunks) * 100);
        dom.progress.style.width = pct + '%';
      }

      // 3. COMPLETE/MERGE
      dom.status.textContent = "Finalizing... merging chunks into video file.";
      const compRes = await fetch(`${API_UPLOADS}/${uploadId}/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });

      if (!compRes.ok) throw new Error("Merging failed on server.");

      const final = await compRes.json();
      
      dom.status.className = "status success";
      dom.status.textContent = "Success! Video uploaded and merged.";
      
      if (final.playbackUrl) {
        dom.player.src = final.playbackUrl;
        dom.videoWrap.style.display = 'block';
      }

    } catch (err) {
      console.error(err);
      dom.status.className = "status error";
      dom.status.textContent = "Error: " + err.message;
      dom.start.disabled = false;
      dom.pause.disabled = true;
    }
  }

  dom.start.onclick = () => {
    dom.start.disabled = true;
    dom.videoWrap.style.display = 'none';
    runUpload();
  };

  dom.pause.onclick = () => {
    paused = !paused;
    dom.pause.textContent = paused ? "Resume" : "Pause";
  };
</script>

</body>
</html>